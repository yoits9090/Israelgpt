name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

  # Allow manual deploys from GitHub UI
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/ubuntu/guildest
  STATUS_WEBHOOK: ${{ secrets.status }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4

    - name: Notify Deploy Started
      if: always() && env.STATUS_WEBHOOK != ''
      run: |
        python microservices/status_notifier/main.py \
          --event deploy \
          --status started \
          --summary "Deploy to EC2 started" \
          --ref "${{ github.ref }}" \
          --commit "${{ github.sha }}" \
          --actor "${{ github.actor }}" \
          --component "docker build + containers"

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: ${{ env.DEPLOY_PATH }}
        rm: false

    - name: Build and Deploy
      id: deploy_step
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        command_timeout: 10m
        script: |
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          # Create .env file from secrets
          echo "Creating .env file..."
          echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" > .env
          echo "AUTO_ROLE_ID=${{ secrets.AUTO_ROLE_ID }}" >> .env
          echo "GROQ_API=${{ secrets.GROQ_API }}" >> .env
          echo "PRIMARY_GUILD_ID=${{ secrets.PRIMARY_GUILD_ID }}" >> .env
          echo "DISCORDBUMP_TOKEN=${{ secrets.DISCORDBUMP_TOKEN }}" >> .env
          echo "token=${{ secrets.DISCORDBUMP_TOKEN }}" >> .env
          
          # Note: Grafana secrets passed directly to grafana-agent container (not in .env)

          # Ensure data directory exists
          mkdir -p ${{ env.DEPLOY_PATH }}/data
          
          # Build with BuildKit for faster cached builds
          echo "Building Docker image..."
          sudo DOCKER_BUILDKIT=1 docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t guildest-bot:${{ github.sha }} \
            .
          
          # ============================================
          # SMOKE TEST - Verify container starts before swapping
          # ============================================
          echo "üß™ Running smoke test on new image..."
          
          # Notify smoke test started
          cd ${{ env.DEPLOY_PATH }}
          if [ -n "${{ secrets.status }}" ]; then
            STATUS_WEBHOOK="${{ secrets.status }}" python3 microservices/status_notifier/main.py \
              --event smoke_test \
              --status started \
              --summary "Testing new Docker image before deploy" \
              --ref "${{ github.ref }}" \
              --commit "${{ github.sha }}" \
              --actor "${{ github.actor }}" \
              --component "docker image validation" || true
          fi
          
          # Run import check (catches import errors like missing modules)
          echo "Testing imports..."
          if ! sudo docker run --rm -w /app/src \
            guildest-bot:${{ github.sha }} \
            python -c "from cogs import setup_all_cogs; from core.bot import bot; print('‚úÖ Imports OK')"; then
            echo "‚ùå SMOKE TEST FAILED: Import errors detected"
            # Notify smoke test failed
            if [ -n "${{ secrets.status }}" ]; then
              STATUS_WEBHOOK="${{ secrets.status }}" python3 microservices/status_notifier/main.py \
                --event smoke_test \
                --status failure \
                --summary "Import errors detected - deploy aborted" \
                --ref "${{ github.ref }}" \
                --commit "${{ github.sha }}" \
                --actor "${{ github.actor }}" \
                --notes "Old container remains running. Check imports in cogs/core modules." || true
            fi
            echo "Old container remains running - deploy aborted"
            exit 1
          fi
          
          # Import test passed - notify success
          echo "‚úÖ Smoke test passed - all imports validated"
          if [ -n "${{ secrets.status }}" ]; then
            STATUS_WEBHOOK="${{ secrets.status }}" python3 microservices/status_notifier/main.py \
              --event smoke_test \
              --status success \
              --summary "All imports validated - proceeding with deploy" \
              --ref "${{ github.ref }}" \
              --commit "${{ github.sha }}" \
              --actor "${{ github.actor }}" || true
          fi
          
          # ============================================
          # DEPLOY - Only runs if smoke test passed
          # ============================================
          echo "‚úÖ Smoke test passed - proceeding with deploy..."
          
          # Tag as latest now that we know it works
          sudo docker tag guildest-bot:${{ github.sha }} guildest-bot:latest
          
          # Stop old containers gracefully
          echo "Stopping old containers..."
          sudo docker stop guildest-bot guildest-autobumper grafana-agent 2>/dev/null || true
          sudo docker rm guildest-bot guildest-autobumper grafana-agent 2>/dev/null || true
          
          # Create Docker network for internal communication
          sudo docker network create guildest-net 2>/dev/null || true
          
          # Start bot container with resource limits
          echo "Starting bot container..."
          sudo docker run -d \
            --name guildest-bot \
            --network guildest-net \
            --restart unless-stopped \
            --env-file .env \
            --memory=512m \
            --log-opt max-size=10m \
            --log-opt max-file=3 \
            -v ${{ env.DEPLOY_PATH }}/data:/app/data \
            guildest-bot:latest

          # Start autobumper container
          echo "Starting autobumper container..."
          sudo docker run -d \
            --name guildest-autobumper \
            --network guildest-net \
            --restart unless-stopped \
            --env-file .env \
            --memory=128m \
            --log-opt max-size=5m \
            --log-opt max-file=2 \
            guildest-bot:latest \
            bash -c 'cd autobumper && node index.js'
          
          # Start Grafana Agent for metrics (if configured)
          if [ -n "${{ secrets.GRAFANA_REMOTE_WRITE_URL }}" ]; then
            echo "Starting Grafana Agent for metrics..."
            sudo docker run -d \
              --name grafana-agent \
              --network guildest-net \
              --restart unless-stopped \
              -e "GRAFANA_REMOTE_WRITE_URL=${{ secrets.GRAFANA_REMOTE_WRITE_URL }}" \
              -e "GRAFANA_METRICS_USER=${{ secrets.GRAFANA_METRICS_USER }}" \
              -e "GRAFANA_API_KEY=${{ secrets.GRAFANA_API_KEY }}" \
              --memory=64m \
              --log-opt max-size=5m \
              --log-opt max-file=2 \
              -v ${{ env.DEPLOY_PATH }}/grafana-agent.yaml:/etc/agent/agent.yaml \
              grafana/agent:latest \
              -config.file=/etc/agent/agent.yaml \
              -config.expand-env
          else
            echo "Skipping Grafana Agent (GRAFANA_REMOTE_WRITE_URL not set)"
          fi

          # Final health check
          echo "Checking container health..."
          sleep 5
          if sudo docker ps | grep -q guildest-bot; then
            echo "‚úÖ Bot is running"
          else
            echo "‚ùå Bot failed to start"
            sudo docker logs guildest-bot --tail 50
            exit 1
          fi

          # Cleanup old images (keep last 3)
          echo "Cleaning up old images..."
          sudo docker image prune -f
          
          echo "‚úÖ Deploy complete!"

    - name: Notify Deploy Result
      if: always() && env.STATUS_WEBHOOK != ''
      run: |
        python microservices/status_notifier/main.py \
          --event deploy \
          --status "${{ steps.deploy_step.outcome }}" \
          --summary "Docker build and EC2 container restart" \
          --ref "${{ github.ref }}" \
          --commit "${{ github.sha }}" \
          --actor "${{ github.actor }}" \
          --notes "Includes docker build, container restart, and health check on EC2."

    - name: Notify Discord
      if: always()
      continue-on-error: true
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ -n "$DISCORD_WEBHOOK" ]; then
          STATUS="${{ job.status }}"
          COMMIT="${{ github.sha }}"
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993
            TITLE="‚úÖ Deploy Successful"
          else
            COLOR=15158332
            TITLE="‚ùå Deploy Failed"
          fi
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"Commit: \`${COMMIT:0:7}\`\",\"color\":$COLOR}]}" \
            "$DISCORD_WEBHOOK"
        fi
