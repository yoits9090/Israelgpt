name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

  # Allow manual deploys from GitHub UI
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/ubuntu/israelgpt
  STATUS_WEBHOOK: ${{ secrets.status }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4

    - name: Notify Deploy Started
      if: always() && env.STATUS_WEBHOOK != ''
      run: |
        python microservices/status_notifier/main.py \
          --event deploy \
          --status started \
          --summary "Deploy to EC2 started" \
          --ref "${{ github.ref }}" \
          --commit "${{ github.sha }}" \
          --actor "${{ github.actor }}" \
          --component "docker build + containers"

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: ${{ env.DEPLOY_PATH }}
        rm: false

    - name: Build and Deploy
      id: deploy_step
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        command_timeout: 10m
        script: |
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          # Create .env file from secrets
          echo "Creating .env file..."
          echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" > .env
          echo "AUTO_ROLE_ID=${{ secrets.AUTO_ROLE_ID }}" >> .env
          echo "GROQ_API=${{ secrets.GROQ_API }}" >> .env
          echo "PRIMARY_GUILD_ID=${{ secrets.PRIMARY_GUILD_ID }}" >> .env
          echo "DISCORDBUMP_TOKEN=${{ secrets.DISCORDBUMP_TOKEN }}" >> .env
          echo "token=${{ secrets.DISCORDBUMP_TOKEN }}" >> .env

          # Ensure data directory exists
          mkdir -p ${{ env.DEPLOY_PATH }}/data
          
          # Build with BuildKit for faster cached builds
          echo "Building Docker image..."
          sudo DOCKER_BUILDKIT=1 docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t israelgpt-bot:${{ github.sha }} \
            .
          
          # ============================================
          # SMOKE TEST - Verify container starts before swapping
          # ============================================
          echo "üß™ Running smoke test on new image..."
          
          # Run import check (catches import errors like missing modules)
          echo "Testing imports..."
          if ! sudo docker run --rm \
            israelgpt-bot:${{ github.sha }} \
            python -c "from cogs import setup_all_cogs; from core.bot import IsraelGPT; print('‚úÖ Imports OK')"; then
            echo "‚ùå SMOKE TEST FAILED: Import errors detected"
            echo "Old container remains running - deploy aborted"
            exit 1
          fi
          
          # Run container briefly to verify startup (with fake token to prevent actual connection)
          echo "Testing container startup..."
          sudo docker run -d \
            --name israelgpt-bot-test \
            --env-file .env \
            -e DISCORD_TOKEN=test_smoke_check \
            --memory=512m \
            israelgpt-bot:${{ github.sha }}
          
          # Wait and check if it survives initial startup (5 seconds)
          sleep 5
          
          if sudo docker ps | grep -q israelgpt-bot-test; then
            echo "‚úÖ Smoke test passed - container starts successfully"
            sudo docker stop israelgpt-bot-test 2>/dev/null || true
            sudo docker rm israelgpt-bot-test 2>/dev/null || true
          else
            echo "‚ùå SMOKE TEST FAILED: Container crashed on startup"
            echo "--- Container logs ---"
            sudo docker logs israelgpt-bot-test --tail 100
            sudo docker rm israelgpt-bot-test 2>/dev/null || true
            echo "Old container remains running - deploy aborted"
            exit 1
          fi
          
          # ============================================
          # DEPLOY - Only runs if smoke test passed
          # ============================================
          echo "‚úÖ Smoke test passed - proceeding with deploy..."
          
          # Tag as latest now that we know it works
          sudo docker tag israelgpt-bot:${{ github.sha }} israelgpt-bot:latest
          
          # Stop old containers gracefully
          echo "Stopping old containers..."
          sudo docker stop israelgpt-bot israelgpt-autobumper 2>/dev/null || true
          sudo docker rm israelgpt-bot israelgpt-autobumper 2>/dev/null || true
          
          # Start bot container with resource limits
          echo "Starting bot container..."
          sudo docker run -d \
            --name israelgpt-bot \
            --restart unless-stopped \
            --env-file .env \
            --memory=512m \
            --log-opt max-size=10m \
            --log-opt max-file=3 \
            -v ${{ env.DEPLOY_PATH }}/data:/app/data \
            israelgpt-bot:latest

          # Start autobumper container
          echo "Starting autobumper container..."
          sudo docker run -d \
            --name israelgpt-autobumper \
            --restart unless-stopped \
            --env-file .env \
            --memory=128m \
            --log-opt max-size=5m \
            --log-opt max-file=2 \
            israelgpt-bot:latest \
            bash -c 'cd autobumper && node index.js'

          # Final health check
          echo "Checking container health..."
          sleep 5
          if sudo docker ps | grep -q israelgpt-bot; then
            echo "‚úÖ Bot is running"
          else
            echo "‚ùå Bot failed to start"
            sudo docker logs israelgpt-bot --tail 50
            exit 1
          fi

          # Cleanup old images (keep last 3)
          echo "Cleaning up old images..."
          sudo docker image prune -f
          
          echo "‚úÖ Deploy complete!"

    - name: Notify Deploy Result
      if: always() && env.STATUS_WEBHOOK != ''
      run: |
        python microservices/status_notifier/main.py \
          --event deploy \
          --status "${{ steps.deploy_step.outcome }}" \
          --summary "Docker build and EC2 container restart" \
          --ref "${{ github.ref }}" \
          --commit "${{ github.sha }}" \
          --actor "${{ github.actor }}" \
          --notes "Includes docker build, container restart, and health check on EC2."

    - name: Notify Discord
      if: always()
      continue-on-error: true
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ -n "$DISCORD_WEBHOOK" ]; then
          STATUS="${{ job.status }}"
          COMMIT="${{ github.sha }}"
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993
            TITLE="‚úÖ Deploy Successful"
          else
            COLOR=15158332
            TITLE="‚ùå Deploy Failed"
          fi
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"Commit: \`${COMMIT:0:7}\`\",\"color\":$COLOR}]}" \
            "$DISCORD_WEBHOOK"
        fi
